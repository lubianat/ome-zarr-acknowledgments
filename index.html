<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>OME-Zarr Acknowledgments</title>

    <style>
        :root {
            color-scheme: dark light;
        }

        /* The theme is controlled via CSS variables on body */
        body {
            margin: 0;
            padding: 2rem;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

            --bg-color: #111;
            --text-color: #f5f5f5;
            --muted-color: #ccc;
            --soft-muted: #888;

            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.25s ease, color 0.25s ease;
        }

        /* Light theme overrides */
        body.light {
            --bg-color: #f5f5f5;
            --text-color: #111;
            --muted-color: #555;
            --soft-muted: #777;
        }

        h1 {
            margin: 0 0 1rem;
            font-weight: 600;
            font-size: 1.5rem;
        }

        h2 {
            margin-top: 2rem;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted-color);
        }

        #paper-people {
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .country {
            font-weight: 700;
            margin-right: 0.25rem;
        }

        .aff {
            font-weight: 600;
            margin: 0 0.25rem;
        }

        .people-list {
            margin-left: 0.15rem;
        }

        .sep {
            margin: 0 0.75rem;
            opacity: 0.7;
            color: var(--soft-muted);
        }

        #others {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem 1rem;
        }

        .others-name {
            font-size: 0.8rem;
            opacity: 0.85;
        }

        .error {
            color: #ff6b6b;
            margin-top: 1rem;
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .theme-toggle {
            border: 1px solid var(--soft-muted);
            background: transparent;
            color: inherit;
            border-radius: 999px;
            padding: 0.3rem 0.9rem;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .theme-toggle:hover {
            border-color: var(--muted-color);
        }
    </style>

    <!-- js-yaml from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>

<body>
    <div class="top-bar">
        <h1>OME-Zarr &amp; OME-NGFF Contributors</h1>
        <button id="theme-toggle" class="theme-toggle" type="button">Switch to light mode</button>
    </div>

    <h2>Paper authors (by country / affiliation)</h2>
    <div id="paper-people"></div>

    <h2>image.sc / NGFF channel (no listed affiliation)</h2>
    <div id="others"></div>

    <div id="error" class="error"></div>

    <script>
        function getRainbowColor(index, total) {
            // spread hues from red (0) to violet (~300)
            const denom = Math.max(1, total - 1);
            const hue = Math.round((index / denom) * 300);
            return `hsl(${hue}, 80%, 60%)`;
        }

        function initThemeToggle() {
            const btn = document.getElementById('theme-toggle');
            const body = document.body;

            // initial mode based on prefers-color-scheme
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                body.classList.add('light');
            }

            function updateLabel() {
                const light = body.classList.contains('light');
                btn.textContent = light ? 'Switch to dark mode' : 'Switch to light mode';
            }

            updateLabel();

            btn.addEventListener('click', () => {
                body.classList.toggle('light');
                updateLabel();
            });
        }

        async function loadData() {
            const errorEl = document.getElementById('error');

            try {
                const [peopleResp, affResp] = await Promise.all([
                    fetch('people.yaml'),
                    fetch('affiliation_shortener.yaml'),
                ]);

                if (!peopleResp.ok) {
                    throw new Error('Cannot load people.yaml: ' + peopleResp.statusText);
                }
                if (!affResp.ok) {
                    throw new Error('Cannot load affiliation_shortener.yaml: ' + affResp.statusText);
                }

                const [peopleText, affText] = await Promise.all([
                    peopleResp.text(),
                    affResp.text(),
                ]);

                const peopleData = jsyaml.load(peopleText); // { people, resources }
                const affData = jsyaml.load(affText);       // { affiliations }

                const people = peopleData.people || [];
                const resources = peopleData.resources || [];
                const affiliations = affData.affiliations || [];

                // Map full affiliation -> {short_name, country_code}
                const affMap = new Map();
                affiliations.forEach(a => {
                    if (a.full_name) affMap.set(a.full_name, a);
                });

                function getAffEntry(full) {
                    return affMap.get(full) || {
                        full_name: full,
                        short_name: full,
                        country_code: '--',
                    };
                }

                // People appearing in any DOI resource are "paper authors"
                const paperPeopleSet = new Set();
                resources
                    .filter(r => typeof r.url === 'string' && r.url.includes('doi.org'))
                    .forEach(r => {
                        (r.people || []).forEach(name => paperPeopleSet.add(name));
                    });

                const paperPeople = people.filter(p => paperPeopleSet.has(p.name));
                const imageScOnly = people.filter(p => {
                    const hasAff = Array.isArray(p.affiliations) && p.affiliations.length > 0;
                    return !paperPeopleSet.has(p.name) && !hasAff;
                });

                // Build blocks: { country_code, aff_short, people[] }
                const blocksMap = new Map(); // key: country|short
                paperPeople.forEach(person => {
                    (person.affiliations || []).forEach(fullAff => {
                        const entry = getAffEntry(fullAff);
                        const shortName = entry.short_name || entry.full_name;
                        const country = entry.country_code || '--';
                        const key = country + '|' + shortName;

                        if (!blocksMap.has(key)) {
                            blocksMap.set(key, {
                                country_code: country,
                                aff_short: shortName,
                                people: [],
                            });
                        }
                        const block = blocksMap.get(key);
                        if (!block.people.includes(person.name)) {
                            block.people.push(person.name);
                        }
                    });
                });

                const blocks = Array.from(blocksMap.values());

                // Group by country
                const countryGroups = new Map();
                blocks.forEach(b => {
                    const c = b.country_code;
                    if (!countryGroups.has(c)) countryGroups.set(c, []);
                    countryGroups.get(c).push(b);
                });

                // Sort countries, and sort affiliations inside each country
                const countryCodes = Array.from(countryGroups.keys()).sort();
                countryCodes.forEach(c => {
                    countryGroups.get(c).sort((a, b) => {
                        if (a.aff_short < b.aff_short) return -1;
                        if (a.aff_short > b.aff_short) return 1;
                        return 0;
                    });
                });

                const paperContainer = document.getElementById('paper-people');
                const totalAffBlocks = blocks.length;
                let affIndex = 0;

                countryCodes.forEach((country, ci) => {
                    const countryBlocks = countryGroups.get(country);
                    if (!countryBlocks || !countryBlocks.length) return;

                    // separator between countries
                    if (ci > 0) {
                        const sep = document.createElement('span');
                        sep.className = 'sep';
                        sep.textContent = '//';
                        paperContainer.appendChild(sep);
                    }

                    const countrySpan = document.createElement('span');
                    countrySpan.className = 'country';
                    countrySpan.textContent = country;
                    paperContainer.appendChild(countrySpan);

                    countryBlocks.forEach(block => {
                        const affSpan = document.createElement('span');
                        affSpan.className = 'aff';
                        affSpan.textContent = block.aff_short;
                        affSpan.style.color = getRainbowColor(affIndex, totalAffBlocks);
                        affIndex++;
                        paperContainer.appendChild(affSpan);

                        const peopleSpan = document.createElement('span');
                        peopleSpan.className = 'people-list';
                        peopleSpan.textContent = ' ' + block.people.join(', ');
                        paperContainer.appendChild(peopleSpan);
                    });
                });

                // Render image.sc-only names below
                const othersContainer = document.getElementById('others');
                imageScOnly.forEach(person => {
                    const div = document.createElement('div');
                    div.className = 'others-name';
                    div.textContent = person.name;
                    othersContainer.appendChild(div);
                });

            } catch (err) {
                console.error(err);
                errorEl.textContent = err.message;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initThemeToggle();
            loadData();
        });
    </script>
</body>

</html>